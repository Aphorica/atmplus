#! /bin/sh
DESTDIR='../docs/state_graphs'
BABEL_ARGS='--no-babelrc --presets=env,stage-3'
babel $BABEL_ARGS bin/visualize --out-file bin/visualize_run
ex - bin/visualize_run << EDIT
:/INTEROP
:s/INTEROP/_interopRequireDefault/
:wq
EDIT
chmod 755 bin/visualize_run
##
pushd ./bin
rm $DESTDIR/*
FILES='atm-main atm-transaction fsm_dot_styles'
for FILE in $FILES
do
  echo "transpiling: $FILE"
  babel $BABEL_ARGS ../src/fsm/$FILE.js --out-file ./$FILE.js
done
##
RUNNABLES='atm-main atm-transaction'
for RUNNABLE in $RUNNABLES
do
  echo "running: $RUNNABLE"
  ./visualize_run $RUNNABLE.js >$RUNNABLE.dot
  ex $RUNNABLE.dot <$RUNNABLE.ex
  dot -Tsvg -o ${DESTDIR}/${RUNNABLE}.svg $RUNNABLE.dot
  ex - $RUNNABLE.dot << DOTEDIT
:2s/= spline/= ortho/
:.,\$s/; label.*]/]/
:wq
DOTEDIT
  dot -Tsvg -o ${DESTDIR}/${RUNNABLE}_s.svg $RUNNABLE.dot
done
popd
